<!DOCTYPE html>
<html>
<head>
	<title>Find a Company</title>

	<script src="/utils.js"></script>
	<!-- <script src="/fancy-table.js"></script>
	<script src="/table-view.js"></script> -->

<body>

	<h1>Find a Company</h1>
	<input id='search-input'>

	<script>
		// Model to handle API communication
		function DataTable () {
			this.baseUrl = 'http://localhost:3000/api/companies/';
			this.length = 0;
			this.data = null;
			this.params = {
				searchTerm: null,
				start: 0,
				limit: 10,
				laborType: null
			}
		}

		DataTable.prototype.constructUrl = function () {
			var url = this.baseUrl;
			var {searchTerm, start, limit, laborType} = this.params;
			var paramStrings = [];
			searchTerm ? paramStrings.push('q=' + searchTerm) : noop();
			(start !== 0) ? paramStrings.push('start=' + start) : noop();
			limit ? paramStrings.push('limit=' + limit) : noop();
			laborType ? paramStrings.push('laborType=' + laborType.join(',')) : noop();
			paramStrings.forEach((param) => {
				url += (url.split('?')[1] ? '&':'?') + param;
			})
			return url;
		}

		DataTable.prototype.getData = function () {
			return promise = new Promise((resolve, reject) => {
				var url = this.constructUrl()
				const _this = this;
				fetch(url).then((data) => 
					data.json()
				).then((data) => {
					_this.data = data.results;
					_this.length = data.total;
					resolve(_this);
				}).catch((error) => {
					console.log('An error occured: ', error);
				})
			});
		}

		DataTable.prototype.getNextPage = function() {
			var {searchTerm, start, limit, laborType} = this.params;
			(start + limit < this.length) ? (this.params.start += limit) : noop();
			this.getData().then((dataTable) => {
				return dataTable;
			});
		};

		DataTable.prototype.getPreviousPage = function() {
			var {searchTerm, start, limit, laborType} = this.params;
			(start - limit >= 0) ? (this.params.start -= limit) : noop();
			this.getData().then((dataTable) => {
				return dataTable;
			});
		};

		DataTable.prototype.setLimit = function (limit) {
			(limit >= 1 && limit <= 100) ? this.params.limit = limit : (
				console.log('Limit must be between 0 and 100')
			);
			this.getData().then((dataTable) => {
				return dataTable;
			});
		}

		// View to handle page rendering of dataTable
		function FancyTable (dataTable) {
			this.table = dataTable;
		}

		FancyTable.prototype.render = function () {
			var $table = document.createElement('table');
			var $body = document.createElement('tbody');
			this.table.data.map((company) => {
				var $cell = document.createElement('td');
				$cell.innerHTML = company.name;
				var $row = document.createElement('tr');
				$row.appendChild($cell);
				$body.appendChild($row);
			});
			return $body;
		}

	</script>
	
	<script>
		document.addEventListener("DOMContentLoaded", function(){
			var dataTable = new DataTable();
			dataTable.getData().then((dataTable) => {
				var $table = new FancyTable(dataTable).render();
				document.body.appendChild($table);
			});
		});
	</script>

</body>
</html>
