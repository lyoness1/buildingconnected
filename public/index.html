<!DOCTYPE html>
<html>
<head>
	<title>Find a Company</title>

	<script src="/utils.js"></script>
	<!-- <script src="/fancy-table.js"></script>
	<script src="/table-view.js"></script> -->

<body>

	<h1>Find a Company</h1>
	<input id='search-input'>

	<script>
		// Model to handle API communication
		function DataTable () {
			this.baseUrl = 'http://localhost:3000/api/companies/';
			this.length = 0;
			this.data = null;
			this.params = {
				searchTerm: null,
				start: 0,
				limit: 10,
				laborType: null
			}
		}

		DataTable.prototype.constructUrl = function () {
			var url = this.baseUrl;
			var {searchTerm, start, limit, laborType} = this.params;
			var paramStrings = [];
			searchTerm ? paramStrings.push('q=' + searchTerm) : noop();
			(start !== 0) ? paramStrings.push('start=' + start) : noop();
			limit ? paramStrings.push('limit=' + limit) : noop();
			laborType ? paramStrings.push('laborType=' + laborType.join(',')) : noop();
			paramStrings.forEach((param) => {
				url += (url.split('?')[1] ? '&':'?') + param;
			})
			return url;
		}

		DataTable.prototype.getDataPromise = function () {
			var url = this.constructUrl();
			return fetch(url).then((response) => {
				return response.json().then((data) => {
					this.data = data.results;
					this.length = data.total;
					return Promise.resolve(this);
				}).catch((error) => {
          return Promise.reject(new ResponseError('Invalid JSON: ' + error.message));
        });
			}).then((dataTable) => {
				return dataTable;
			}).catch((error) => {
		    return Promise.reject(new NetworkError(error.message));
		  });
		}

		DataTable.prototype.getNextPagePromise = function() {
			var {searchTerm, start, limit, laborType} = this.params;
			(start + limit < this.length) ? (this.params.start += limit) : noop();
			return this.getDataPromise();
		};

		DataTable.prototype.getPreviousPagePromise = function() {
			var {searchTerm, start, limit, laborType} = this.params;
			(start - limit >= 0) ? (this.params.start -= limit) : noop();
			return this.getDataPromise();
		};

		DataTable.prototype.setLimitPromise = function (limit) {
			(limit >= 1 && limit <= 100) ? this.params.limit = limit : (
				console.log('Limit must be between 0 and 100')
			);
			this.getDataPromise();
		}

		// View to handle page rendering of dataTable
		function FancyTable (dataTable) {
			this.table = dataTable;
		}

		FancyTable.prototype.render = function () {
			var $table = document.createElement('table');
			var $body = document.createElement('tbody');
			this.table.data.map((company) => {
				var $cell = document.createElement('td');
				$cell.innerHTML = company.name;
				var $row = document.createElement('tr');
				$row.appendChild($cell);
				$body.appendChild($row);
			});
			return $body;
		}

	</script>
	
	<script>
		document.addEventListener("DOMContentLoaded", function(){
			var dataTable = new DataTable();
			dataTable.getDataPromise().then((dataTable) => {
				var $table = new FancyTable(dataTable).render();
				document.body.appendChild($table);
			});
		});
	</script>

</body>
</html>
